@using GabriniCosmetics.Areas.Admin.Models.DTOs
@using Microsoft.IdentityModel.Tokens
@model List<SubprodcutForm>
@addTagHelper *, Microsoft.AspNetCore.Mvc.TagHelpers
<style>
    tr {
        transition: transform 0.3s ease-in-out;
    }
    .draggable-image {
        cursor: grab;
        transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
    }

    .draggable-image:hover {
        transform: scale(1.05); /* Slightly enlarge */
        box-shadow: 0px 4px 10px rgba(0, 0, 0, 0.2); /* Soft shadow */
    }

    .dragging {
        opacity: 0.5; /* Reduce opacity while dragging */
    }

</style>

<div id="_subproductFormContainer">
    <h1>Add Subproducts</h1>
    <div class="row g-3">
        <div class="col-md-12">
            <label class="form-label" for="ImageUploads">Upload Images</label>
            <div id="drop-zone" class="border rounded p-3 d-flex justify-content-center align-items-center">
                <p class="text-muted">Drag & drop your images here or click to upload</p>
                <input id="imageUploadInput" type="file" accept="image/*" class="d-none" multiple>
                @* <input type="hidden" class="d-none" name="NewSubproduct.Base64Image" id="NewSubproductBase64Image"> *@
            </div>
        </div>
    </div>

    <!-- Subproducts Table -->
    <div id="_subproductTableContainer">
        <div class="table-responsive mt-3">
            <table class="table table-bordered" id="subproductTable" style="width: 100%;">
                <thead>
                    <tr>
                        <th>Image</th>
                        <th>Description (En)</th>
                        <th>Description (Ar)</th>
                        <th>
                            <div class="d-flex flex-row align-items-center justify-content-between">
                                <div>
                                    <span>
                                        Availability
                                    </span>
                                </div>
                                <div>
                                    <input id="checkall-available" disabled type="checkbox" onchange="checkAll()" />
                                    <span class="ms-2">Check All</span>
                                </div>
                            </div>
                        </th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="subproductTableBody">
                    @{
                        var index = 0;
                        foreach (var subproduct in Model)
                        {
                            <tr id="subproductRow-@(index + 1)" data-order="@index" draggable="true">
                                <input type="hidden" class="d-none" name="Subproducts[@index].Id" id="Subproducts[@index].Id" value="@subproduct.Id">
                                <td style="padding: .5rem .5rem !important; max-width: 300px;">
                                    <div class="d-flex flex-column align-items-center justify-content-center">
                                        <input type="hidden" class="d-none" name="Subproducts[@index].Base64Image" id="Subproducts[@index].Base64Image" value="@subproduct.Base64Image">
                                        <img src="~/uploads/@subproduct.ExistingImagePath" class="draggable-image" style="max-width: 300px; max-height: 300px;" alt="Image did not load" />
                                    </div>
                                </td>
                                <td style="padding: .5rem .5rem !important">
                                    <div class="d-flex flex-column align-items-center justify-content-center">
                                        <input id="Subproducts[@index].DescriptionEn" name="Subproducts[@index].DescriptionEn" type="text" class="form-control" placeholder="Enter description (EN)" value="@subproduct.DescriptionEn" />
                                    </div>
                                </td>
                                <td style="padding: .5rem .5rem !important">
                                    <div class="d-flex flex-column align-items-center justify-content-center">
                                        <input id="Subproducts[@index].DescriptionAr" name="Subproducts[@index].DescriptionAr" type="text" class="form-control" placeholder="Enter description (AR)" value="@subproduct.DescriptionAr" />
                                    </div>
                                </td>
                                <td style="padding: .5rem .5rem !important">
                                    <div class="d-flex flex-row align-items-center justify-content-center">
                                        <input id="Subproducts[@index].IsAvailability" name="Subproducts[@index].IsAvailability" type="checkbox" onchange="checkIsAvailable(this)" value="true" @(subproduct.IsAvailability ? "checked" : "") />
                                        <span class="ms-2" >@(subproduct.IsAvailability ? "Available" : "Not available")</span>
                                    </div>
                                </td>
                                <td style="padding: .5rem .5rem !important">
                                    <div class="d-flex flex-column align-items-center gap-1 justify-content-center">
                                        <div class="subproduct-action-icon" onclick="moveUp(this)">
                                            <a class="action-icon">
                                                <i class="fa-regular fa-chevron-up"></i>
                                            </a>
                                        </div>
                                        <div class="subproduct-action-icon" data-bs-toggle="modal" data-bs-target="#deleteModal" data-id="@index">
                                            <a class="action-icon">
                                                <i class="fa-regular fa-trash"></i>
                                            </a>
                                        </div>
                                        <div class="subproduct-action-icon" onclick="moveDown(this)">
                                            <a class="action-icon">
                                                <i class="fa-regular fa-chevron-down"></i>
                                            </a>
                                        </div>
                                    </div>
                                </td>
                            </tr>

                            index++;
                        }
                    }
                </tbody>
            </table>
        </div>
    </div>
</div>

<div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteModalLabel">Delete</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                Are you sure you want to delete this subproduct?
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-danger" data-bs-dismiss="modal">No</button>
                <button type="button" class="btn btn-primary" id="confirmDeleteButton">Yes</button>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const tableBody = document.getElementById('subproductTableBody');
        let draggedRow = null; // Stores the row being dragged

        const dropZone = document.getElementById('drop-zone');
        const imageUploadInput = document.getElementById('imageUploadInput');

        // Click to open file input
        dropZone.addEventListener('click', () => imageUploadInput.click());

        // Handle file drag over
        dropZone.addEventListener('dragover', (event) => {
            event.preventDefault();
            dropZone.classList.add('dragover');
        });

        // Handle file drag leave
        dropZone.addEventListener('dragleave', () => dropZone.classList.remove('dragover'));

        // Handle file drop
        dropZone.addEventListener('drop', (event) => {
            event.preventDefault();
            dropZone.classList.remove('dragover');
            handleFiles(event.dataTransfer.files);
        });

        // Handle file input change
        imageUploadInput.addEventListener('change', (event) => {
            handleFiles(event.target.files);
        });

        function handleFiles(files) {
            for (let file of files) {
                if (!file.type.startsWith('image/')) continue; // Ignore non-images
                const reader = new FileReader();

                reader.onload = function (event) {
                    addImageToTable(event.target.result, file.name, file);
                };

                reader.readAsDataURL(file);
            }

            reorderInputNames(); // Update input names after inserting
        }

        let rowId = @Json.Serialize(Model.Count + 1);
        console.log(rowId);
        if(rowId > 1)
        {
            const input = $('#checkall-available');
            input.prop('disabled', false);

            const inputs = $("input[name$='IsAvailability']");
            let allChecked = true;
            inputs.each(function(index, element) {
                const checked = $(element).is(':checked');
                if(!checked)
                {
                    allChecked = false;
                    return;
                }
            });

            if(allChecked)
            {
                input.prop('checked', true);
                input.next('span').replaceWith('<span>Uncheck All</span>');
            }
        }

    function enableRowDragging() {
        document.querySelectorAll("#subproductTableBody tr").forEach(row => {
            const img = row.querySelector("td img"); // Get the image inside the row
            row.setAttribute("draggable", "true"); // Make the row draggable

            img.style.cursor = "grab"; // Indicate draggable area
            img.addEventListener("mousedown", () => {
                row.style.opacity = "0.5"; // Reduce opacity when dragging starts
            });

            img.addEventListener("mouseup", () => {
                row.style.opacity = "1"; // Reset opacity
            });

            row.addEventListener("dragstart", (e) => {
                draggedRow = row; // Store the row being dragged
                e.dataTransfer.effectAllowed = "move";
                e.dataTransfer.setData("text/html", row.outerHTML); // Copy row HTML
                row.classList.add("dragging"); // Add a class for styling
            });

            row.addEventListener("dragover", (e) => {
                e.preventDefault(); // Allow dropping
                e.dataTransfer.dropEffect = "move";
                const targetRow = e.target.closest("tr"); // Get the row being hovered over
                if (targetRow && targetRow !== draggedRow) {
                    const bounding = targetRow.getBoundingClientRect();
                    const offset = e.clientY - bounding.top;
                    if (offset > bounding.height / 2) {
                        targetRow.parentNode.insertBefore(draggedRow, targetRow.nextSibling);
                    } else {
                        targetRow.parentNode.insertBefore(draggedRow, targetRow);
                    }
                }
            });

            row.addEventListener("drop", (e) => {
                e.preventDefault();
                draggedRow.style.opacity = "1"; // Reset opacity
                reorderInputNames(); // Reorder names after dropping
            });

            row.addEventListener("dragend", () => {
                draggedRow.classList.remove("dragging");
                reorderInputNames(); // Ensure input names are reordered
            });
        });
    }


       function addImageToTable(imageSrc, fileName, file) {
        const extractedNumber = extractNumberFromFilename(fileName);
        const extractedName = fileName.substring(0, fileName.lastIndexOf('.'));

        const order = tableBody.children.length;
        const rowId = `subproductRow-${order + 1}`;

        const tr = document.createElement('tr');
        tr.id = rowId;
        const dataOrder = extractedNumber ?? (order + 1);
        tr.setAttribute("data-order", dataOrder);
        tr.setAttribute("draggable", "true"); // Enable dragging

        tr.innerHTML = `
            <td style="padding: .5rem .5rem !important; max-width: 300px;">
                <div class="d-flex flex-column align-items-center justify-content-center">
                    <input type="hidden" class="d-none" name="Subproducts[${order}].Base64Image" id="Subproducts[${order}].Base64Image" value="${imageSrc}">
                    <img src="${imageSrc}" class="draggable-image" style="max-width: 300px; max-height: 300px;" alt="Image did not load" />
                </div>
            </td>
            <td style="padding: .5rem .5rem !important">
                <div class="d-flex flex-column align-items-center justify-content-center">
                    <input id="Subproducts[${order}].DescriptionEn" name="Subproducts[${order}].DescriptionEn" type="text" class="form-control" placeholder="Enter description (EN)" value="${extractedName}" />
                </div>
            </td>
            <td style="padding: .5rem .5rem !important">
                <div class="d-flex flex-column align-items-center justify-content-center">
                    <input id="Subproducts[${order}].DescriptionAr" name="Subproducts[${order}].DescriptionAr" type="text" class="form-control" placeholder="Enter description (AR)" value="${extractedName}" />
                </div>
            </td>
            <td style="padding: .5rem .5rem !important">
                <div class="d-flex flex-row align-items-center justify-content-center">
                    <input id="Subproducts[${order}].IsAvailability" name="Subproducts[${order}].IsAvailability" type="checkbox" onchange="checkIsAvailable(this)"  value="true"/>
                    <span class="ms-2" >Not available</span>
                </div>
            </td>
            <td style="padding: .5rem .5rem !important">
                <div class="d-flex flex-column align-items-center gap-1 justify-content-center">
                    <div class="subproduct-action-icon" onclick="moveUp(this)">
                        <a class="action-icon">
                            <i class="fa-regular fa-chevron-up"></i>
                        </a>
                    </div>
                    <div class="subproduct-action-icon" data-bs-toggle="modal" data-bs-target="#deleteModal" data-id="${order}">
                        <a class="action-icon">
                            <i class="fa-regular fa-trash"></i>
                        </a>
                    </div>
                    <div class="subproduct-action-icon" onclick="moveDown(this)">
                        <a class="action-icon">
                            <i class="fa-regular fa-chevron-down"></i>
                        </a>
                    </div>
                </div>
            </td>
        `;

        const input = $('#checkall-available');
        input.prop('disabled', false);
        input.prop('checked', false);
        input.next('span').replaceWith('<span>Check All</span>');

        insertRowSorted(tr);
        enableRowDragging(); // Enable dragging for new rows
    }

// Extract number from filename
function extractNumberFromFilename(filename) {
    const match = filename.match(/(\d+)(?=\.[^.]+$)/); 
    return match ? parseInt(match[1], 10) : null;
}
function reorderInputNames() {
    const rows = document.querySelectorAll("#subproductTableBody tr");
    rows.forEach((row, index) => {
        row.setAttribute("data-order", index + 1); // Update row order attribute

        // Update input names based on new index
        row.querySelectorAll("input").forEach(input => {
            if (input.name.includes("Base64Image")) {
                input.name = `Subproducts[${index}].Base64Image`;
                input.id = `Subproducts[${index}].Base64Image`;
            }
            else if (input.name.includes("DescriptionEn")) {
                input.name = `Subproducts[${index}].DescriptionEn`;
                input.id = `Subproducts[${index}].DescriptionEn`;
            }
            else if (input.name.includes("DescriptionAr")) {
                input.name = `Subproducts[${index}].DescriptionAr`;
                input.id = `Subproducts[${index}].DescriptionAr`;
            }
            else if (input.name.includes("IsAvailability")) {
                input.name = `Subproducts[${index}].IsAvailability`;
                input.id = `Subproducts[${index}].IsAvailability`;
            }
            else if (input.name.includes("Id")) {
                input.name = `Subproducts[${index}].Id`;
                input.id = `Subproducts[${index}].Id`;
            }
        });
    });
}

// Insert the row in sorted order
function insertRowSorted(newRow) {
    const tbody = document.getElementById("subproductTableBody");
    const rows = Array.from(tbody.children);
    const newRowOrder = parseInt(newRow.getAttribute("data-order")) ?? Number.MAX_SAFE_INTEGER;

    let inserted = false;
    for (let i = 0; i < rows.length; i++) {
        const rowOrder = parseInt(rows[i].getAttribute("data-order")) ?? Number.MAX_SAFE_INTEGER;
        if (newRowOrder < rowOrder) {
            tbody.insertBefore(newRow, rows[i]);
            inserted = true;
            break;
        }
    }

    if (!inserted) {
        tbody.appendChild(newRow); // If no suitable place found, append at the end
    }
}

        window.checkAll = function()
        {
            const inputs = $("input[name$='IsAvailability']");
            const input = $('#checkall-available');
            if(inputs.length == 0)
            {
                input.prop('checked', false);
                input.next('span').replaceWith('<span>Check All</span>');
                return;
            }

            const checked = input.is(':checked');
            if(checked)
            {
                inputs.each(function(index, element) {
                    $(element).prop('checked', true);
                    $(element).next('span').replaceWith('<span class="ms-2">Available</span>');
                });

                input.next('span').replaceWith('<span>Uncheck All</span>');
            }
            else
            {
                inputs.each(function(index, element) {
                    $(element).prop('checked', false);
                    $(element).next('span').replaceWith('<span class="ms-2">Not available</span>');
                });

                input.next('span').replaceWith('<span>Check All</span>');
            }

        }

        window.checkIsAvailable = function(checkBox)
        {
            const checked = $(checkBox).is(':checked');
            $(checkBox).next('span').replaceWith(checked ? '<span class="ms-2">Available</span>' : '<span class="ms-2">Not available</span>');

            const input = $('#checkall-available');
            const inputs = $("input[name$='IsAvailability']");
            let allChecked = true;
            inputs.each(function(index, element) {
                const checked = $(element).is(':checked');
                if(!checked)
                {
                    allChecked = false;
                    return;
                }
            });

            if(allChecked)
            {
                input.prop('checked', true);
                input.next('span').replaceWith('<span>Uncheck All</span>');
            }
            else
            {
                input.prop('checked', false);
                input.next('span').replaceWith('<span>Check All</span>');
            }
        }

        window.removeRow = function(button) {
            button.closest('tr').fadeOut(200, function() {
                $(this).remove();
                reorderInputNames(); // Reorder names after deleting
            });

            const tbody = $('#subproductTableBody');
            if(tbody.find("tr").length === 0)
            {
                const input = $('#checkall-available');
                input.prop('disabled', true);
                input.prop('checked', false);
                input.next('span').replaceWith('<span>Check All</span>');
            }
        };

        window.moveUp = function(button) {
            const row = button.closest('tr');
            if (row.previousElementSibling) {
                $(row).fadeOut(200, function() {
                    $(this).insertBefore($(row.previousElementSibling)).fadeIn(200);
                    reorderInputNames(); // Reorder names after moving up
                });
            }
        };

        window.moveDown = function(button) {
            const row = button.closest('tr');
            if (row.nextElementSibling) {
                $(row).fadeOut(200, function() {
                    $(this).insertAfter($(row.nextElementSibling)).fadeIn(200);
                    reorderInputNames(); // Reorder names after moving down
                });
            }
        };

        let currentDeleteButton = null;
        $('#deleteModal').on('show.bs.modal', function (event) {
            currentDeleteButton = $(event.relatedTarget);
        });

        // Confirm delete button click event
        $('#confirmDeleteButton').click(function () {
            if(!currentDeleteButton)
            {
                return;
            }

            removeRow(currentDeleteButton);

            $('#deleteModal').modal('hide');
        });

        enableRowDragging(); // Ensure drag & drop works for existing rows
    });
</script>


@* <script>
    document.addEventListener('DOMContentLoaded', () => {
        const dropZoneSelector = '#drop-zone';
        const imageUploadInputSelector = '#NewSubproductImage';

        // Event Delegation for drop zone
        document.addEventListener('click', (event) => {
            if (event.target.closest(dropZoneSelector)) {
                const imageUploadInput = document.querySelector(imageUploadInputSelector);
                imageUploadInput.click();
            }
        });

        document.addEventListener('dragover', (event) => {
            if (event.target.closest(dropZoneSelector)) {
                event.preventDefault();
                event.target.classList.add('dragover');
            }
        });

        document.addEventListener('dragleave', (event) => {
            if (event.target.closest(dropZoneSelector)) {
                event.target.classList.remove('dragover');
            }
        });

        document.addEventListener('drop', (event) => {
            if (event.target.closest(dropZoneSelector)) {
                event.preventDefault();
                event.target.classList.remove('dragover');

                const files = event.dataTransfer.files;
                console.log(files)
                handleFiles(files);
            }
        });

        // Event Delegation for file input change
        document.addEventListener('change', (event) => {
            if (event.target.matches(imageUploadInputSelector)) {
                const files = event.target.files;
                handleFiles(files);
            }
        });

        // Function to handle files
        function handleFiles(files) {
            for (let i = 0; i < files.length; i++) {
                handleImageUpload(files[i]);
            }
        }

        // Function to handle individual image upload
        function handleImageUpload(file) {
            const imagePreview = document.getElementById('imagePreview');

            if (file) {
                $('#NewSubproductExistingImagePath').val(null);
                $('#NewSubproductBase64Image').val(null);
                $(imageUploadInputSelector).val('');
                $(imagePreview).html('');
                const reader = new FileReader();
                reader.onload = function (event) {

                    const imgWrapper = document.createElement('div');
                    imgWrapper.classList.add('img-wrapper', 'position-relative');

                    const img = document.createElement('img');
                    const base64 = event.target.result;
                    img.src = base64;
                    $('#NewSubproductBase64Image').val(base64 ?? '');
                    img.classList.add('img-preview');

                    const removeBtn = document.createElement('button');
                    removeBtn.classList.add('btn', 'btn-sm', 'remove-btn', 'position-absolute');
                    removeBtn.innerHTML = '<i class="fa-light fa-trash"></i>';
                    removeBtn.onclick = function () {
                        imgWrapper.remove();
                        $('#NewSubproductBase64Image').val(null);
                        $('#NewSubproductExistingImagePath').val(null);
                        $(imageUploadInputSelector).val('');
                    };

                    imgWrapper.appendChild(img);
                    imgWrapper.appendChild(removeBtn);
                    imagePreview.appendChild(imgWrapper);
                };
                reader.readAsDataURL(file);
            }
        }

        // Convert file to Base64
        // document.addEventListener('change', (event) => {
        //     if (event.target.type === 'file' && event.target.dataset.index) {
        //         const index = event.target.dataset.index;
        //         convertToBase64(event.target, index);
        //     }
        // });

        // function convertToBase64(input, index) {
        //     const file = input.files[0];
        //     if (file) {
        //         const reader = new FileReader();
        //         reader.onload = function (e) {
        //             document.getElementById(`base64Image_${index}`).value = e.target.result;
        //         };
        //         reader.readAsDataURL(file);
        //     }
        // }
    });

    function objectToFormData(obj, formData = new FormData(), parentKey = '') {
        for (const key in obj) {
            if (obj.hasOwnProperty(key)) {
                const value = obj[key];
                const fullKey = parentKey ? `${parentKey}[${key}]` : key;

                if (Array.isArray(value)) {
                    // Handle arrays
                    value.forEach((item, index) => {
                        const arrayKey = `${fullKey}[${index}]`;
                        if (typeof item === 'object' && item !== null) {
                            objectToFormData(item, formData, arrayKey); // Recursive for objects in arrays
                        } else {
                            formData.append(arrayKey, item);
                        }
                    });
                } else if (value && typeof value === 'object' && !(value instanceof File)) {
                    // Recursive for nested objects
                    objectToFormData(value, formData, fullKey);
                } else {
                    // Append scalar values (string, number, boolean, etc.)
                    formData.append(fullKey, value);
                }
            }
        }
        return formData;
    }

    $(async function () {
        const subproducts = Array.from((@Html.Raw(Json.Serialize(Model)))["$values"]);
        $(document).on('click', '#addSubproduct', async function (e) {
            e.preventDefault(); // Prevent default form submission
            $('.text-danger').text('');
            const subproduct = {
                id: null,
                existingImagePath: null,
                descriptionEn: $('#NewSubproductDescriptionEn').val() ?? '',
                descriptionAr: $('#NewSubproductDescriptionAr').val() ?? '',
                image: $('#NewSubproductImage').val(),
                base64Image: $('#NewSubproductBase64Image').val() ?? '',
                isAvailability: $('#NewSubproductIsAvailability').is(':checked'),
            };

            let isValid = true;

            if (subproduct.descriptionEn.trim() === '') { 
                isValid = false;
                $(`[name="NewSubproduct.DescriptionEn"]`).next('.text-danger').text('Description In English Is Required');
            }
            if (subproduct.descriptionAr.trim() === '') {
                isValid = false;
                $(`[name="NewSubproduct.DescriptionAr"]`).next('.text-danger').text('Description In Arabic Is Required');
            }
            if (subproduct.base64Image.trim() === '') {
                isValid = false;
                $(`span[name="NewSubproduct.Base64Image"].text-danger`).text('Image Is Requeired');
            }

            if (!isValid) return;

            const payload = { subproducts: subproducts, subproduct: subproduct };
            const formData = objectToFormData(payload);
            formData.append("__RequestVerificationToken", $('input[name="__RequestVerificationToken"]').val());

            await $.ajax({
                url: '/Admin/Products/AddSubproduct',
                type: 'POST',
                async: true,
                data: formData,
                contentType: false, // Important for FormData
                processData: false, // Important for FormData
                success: function (response) {
                    // Replace the subproducts table with the updated partial view
                    subproducts.push(subproduct);
                    $('#_subproductFormContainer').html(response.renderedPartialView);

                }
            });
        });

        $(document).on('click', '[id^="removeSubproduct_"]', async function (e) {
            e.preventDefault();
            const index = $(this).val();

            const payload = { subproducts: subproducts, index: index };
            const formData = objectToFormData(payload);
            formData.append("__RequestVerificationToken", $('input[name="__RequestVerificationToken"]').val());
            await $.ajax({
                url: '/Admin/Products/RemoveSubproduct',
                type: 'POST',
                async: true,
                data: formData,
                contentType: false, // Important for FormData
                processData: false, // Important for FormData
                success: function (response) {
                    // Replace the current table content
                    subproducts.splice(index, 1);
                    $('#_subproductFormContainer').html(response.renderedPartialView);
                }
            });
        });

        let currentSubprodcut = {};
        let currentSubprodcutIndex = null;
        $(document).on('click', '[id^="editSubproduct_"]', function (e) {
            e.preventDefault();
            $('.text-danger').text('');
            $('#imagePreview').html('');
            $('#addSubproduct').hide();
            $('#saveSubproduct').show();
            $('#cancelEditing').show();

            currentSubprodcutIndex = $(this).val();
            Object.assign(currentSubprodcut, subproducts[currentSubprodcutIndex])

            console.log(currentSubprodcut)

            $('#NewSubproductId').val(currentSubprodcut.id ?? null);
            $('#NewSubproductDescriptionEn').val(currentSubprodcut.descriptionEn);
            $('#NewSubproductDescriptionAr').val(currentSubprodcut.descriptionAr);
            // $('#NewSubproductImage').val(currentSubprodcut.image ?? '');
            $('#NewSubproductExistingImagePath').val(currentSubprodcut.existingImagePath);
            $('#NewSubproductBase64Image').val(currentSubprodcut.base64Image);

            $('#NewSubproductIsAvailability').attr('checked', currentSubprodcut.isAvailability);

            if (currentSubprodcut.existingImagePath ?? flase) {
                setImagePreview(`/uploads/${currentSubprodcut.existingImagePath}`);
            }
            else if (currentSubprodcut.base64Image ?? false) { 
                setImagePreview(currentSubprodcut.base64Image);
            }

        });

        $(document).on('click', '#saveSubproduct', async function (e) {
            e.preventDefault();
            $('.text-danger').text('');
            const subproduct = {
                id: $('#NewSubproductId').val() ?? null,
                existingImagePath: $('#NewSubproductExistingImagePath').val() ?? '',
                descriptionEn: $('#NewSubproductDescriptionEn').val() ?? '',
                descriptionAr: $('#NewSubproductDescriptionAr').val() ?? '',
                image: $('#NewSubproductImage').val(),
                base64Image: $('#NewSubproductBase64Image').val() ?? '',
                isAvailability: $('#NewSubproductIsAvailability').is(':checked'),
            };

            let isValid = true;

            if (subproduct.descriptionEn.trim() === '') {
                isValid = false;
                $(`[name="NewSubproduct.DescriptionEn"]`).next('.text-danger').text('Description In English Is Required');
            }
            if (subproduct.descriptionAr.trim() === '') {
                isValid = false;
                $(`[name="NewSubproduct.DescriptionAr"]`).next('.text-danger').text('Description In Arabic Is Required');
            }
            if (subproduct.base64Image.trim() === '' && subproduct.existingImagePath.trim() === '') {
                isValid = false;
                $(`span[name="NewSubproduct.Base64Image"].text-danger`).text('Image Is Requeired');
            }

            if (!isValid) return;

            const payload = { subproducts: subproducts, subproduct: subproduct, index: currentSubprodcutIndex };

            const formData = objectToFormData(payload);
            formData.append("__RequestVerificationToken", $('input[name="__RequestVerificationToken"]').val());

            await $.ajax({
                url: '/Admin/Products/SaveSubproduct',
                type: 'POST',
                async: true,
                data: formData,
                contentType: false, // Important for FormData
                processData: false, // Important for FormData
                success: function (response) {
                    // Replace the current table content
                    subproducts.splice(currentSubprodcutIndex, 1);
                    subproducts.push(subproduct);
                    $('#_subproductFormContainer').html(response.renderedPartialView);
                }
            });
        });

        $(document).on('click', '#cancelEditing', function (e) {
            e.preventDefault();
            currentSubprodcut = {};
            currentSubprodcutIndex = null;

            $('#NewSubproductId').val(null);
            $('#NewSubproductDescriptionEn').val(null);
            $('#NewSubproductDescriptionAr').val(null);
            $('#NewSubproductImage').val('');
            $('#NewSubproductExistingImagePath').val(null);
            $('#NewSubproductBase64Image').val(null);
            $('#NewSubproductIsAvailability').attr('checked', false);

            $('#imagePreview').html('');

            $('#addSubproduct').show();
            $('#saveSubproduct').hide();
            $('#cancelEditing').hide();
        });

        function setImagePreview(src, isBase64 = false) { 
            const imgWrapper = document.createElement('div');
            imgWrapper.classList.add('img-wrapper', 'position-relative');

            const img = document.createElement('img');
            img.src = src;
            if (isBase64) {
                $('#NewSubproductBase64Image').val(src);
            }
            
            img.classList.add('img-preview');

            const removeBtn = document.createElement('button');
            removeBtn.classList.add('btn', 'btn-sm', 'remove-btn', 'position-absolute');
            removeBtn.innerHTML = '<i class="fa-light fa-trash"></i>';
            removeBtn.onclick = function () {
                imgWrapper.remove();
                $('#NewSubproductBase64Image').val(null);
                $('#NewSubproductExistingImagePath').val(null);
                $(imageUploadInputSelector).val('');
            };

            imgWrapper.appendChild(img);
            imgWrapper.appendChild(removeBtn);
            imagePreview.appendChild(imgWrapper);
        }
    
    });

</script> *@